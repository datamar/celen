{% extends 'public/base.html' %}
{% load static %}
{% load i18n account %}
{% load humanize %}
{% load crispy_forms_tags %}


{% block css_supp %}
<style>
.avatar {
    display: inline-block;
    vertical-align: middle;
    width: 26px;
    height: 26px;
    border-radius: 50%;
}
</style>
{% endblock %}

{% block titre %}{% trans "Profil" %}{% endblock %}

{% block contenu %}
<div class="container section min-vh-100">
<!-- En-tête de la page -->
    <div class="row mb-3 align-items-center">
        <div class="col">
            <div class="card shadow-lg bg-body">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-9">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <img class="rounded-circle mx-auto d-block position-relative img-thumbnail" src="{{ profil.photo.url }}" alt="{{ profil }}" style="width: 100px;height: 100px;">
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h1>
                                        {% if profil.user.last_name or profil.user.first_name %}
                                        {{ profil.user.get_full_name }}
                                        {% else %}
                                        {{ profil.user }}
                                        {% endif %}
                                    </h1>
                                    <small>{{ profil.user.groups.first }} - Créé {{ profil.created|naturaltime }} et modifié {{ profil.modified|naturaltime }} -
                                        Dernière connexion {{ profil.user.last_login|naturaltime }}
                                    </small>
                                </div>
                            </div>
                            <!-- Onglets -->
                            <ul class="nav nav-underline">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#my_load" aria-current="page">
                                        <i class="bi bi-house me-1"></i>My Load
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#my_work">
                                        <i class="bi bi-folder2-open me-1"></i>My Work
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#settings">
                                        <i class="bi bi-gear me-1"></i>Réglages
                                    </a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#celen_wrkld">
                                        <i class="bi bi-clipboard2-pulse me-1"></i>Dashboard Celen
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted fst-italic">Occupation totale (en % du temps de l'Agent)</small>
                            <div class="display-3 fw-bold text-center">
                                <span id="total-contribution" class="text-center">0</span>
                            </div>
                        </div>
                    </div>               
                </div>
            </div>
        </div>
    </div>
    <!-- Contenu des onglets -->
    <div class="row mb-3">
        <div class="col">
            <div class="tab-content">
<!-- My Load -->
                <div id="my_load" class="tab-pane fade show active">
                    {% include "ressource/users/profile_load.html" %}
                </div>
<!-- My Work -->
                <div id="my_work" class="tab-pane fade">
                    {% include "ressource/users/profile_work.html" %}
                </div>
<!-- Réglages -->
                <div id="settings" class="tab-pane fade">
                    {% include "ressource/users/profile_settings.html" %}
                </div>
<!-- Celen -->
                <div id="celen_wrkld" class="tab-pane fade">
                    {% include "ressource/users/profile_workload.html" %}
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block js_supp %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const sliders = document.querySelectorAll('input[type="range"][name*="-contribution"]');
    const totalDisplay = document.getElementById('total-contribution');

    function updateAllOutputs() {
      let total = 0;

      sliders.forEach(function (slider) {
        // Cherche le output associé dans le même conteneur
        const container = slider.closest('.mb-3');  // plus robuste
        const output = container ? container.querySelector('.form-range-value') : null;

        if (output) {
          output.textContent = slider.value + " %";
        }

        total += parseInt(slider.value) || 0;
      });

      // Affiche le total global
      if (totalDisplay) {
        totalDisplay.textContent = total;

        if (total > 100) {
          totalDisplay.classList.add('text-danger', 'fw-bold');
          totalDisplay.innerHTML = total + " <span class='ms-1'>&#9888;</span>";
        } else {
          totalDisplay.classList.remove('text-danger', 'fw-bold');
        }
      }
    }

    // Initialisation
    updateAllOutputs();

    // Mise à jour à chaque interaction
    sliders.forEach(function (slider) {
      slider.addEventListener('input', updateAllOutputs);
    });
  });
</script>
{% endblock %}